{% extends 'base.html' %}

{% block title %}Courses{% endblock %}

{% block content %}
<h2 style="text-align:center; margin-bottom:12px;">Available Courses</h2>

<div id="courses-controls" style="text-align:center; margin-bottom:18px;">
    <span id="courses-count" style="font-weight:600; margin-right:15px;">Loading...</span>
    <label style="cursor:pointer;"><input type="checkbox" id="filter-online" style="margin-right:6px;">Online only</label>
</div>

<div id="course-list" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center;">
    <!-- Courses will be loaded here dynamically via JS -->
</div>

<div id="courses-empty" style="text-align:center; margin-top:30px; display:none; color:#666;">No courses available.</div>

<script>
function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

let _courses_cache = [];

function renderCourses(courses) {
    const container = document.getElementById('course-list');
    const empty = document.getElementById('courses-empty');
    const countEl = document.getElementById('courses-count');

    container.innerHTML = '';
    empty.style.display = 'none';
    countEl.textContent = `${courses.length} course(s)`;

    if (!courses || courses.length === 0) {
        empty.style.display = 'block';
        return;
    }

    container.innerHTML = courses.map(course => {
        return `
        <div style="
            background:#fff; 
            padding:20px; 
            border-radius:12px; 
            box-shadow:0 6px 18px rgba(0,0,0,0.1); 
            width:300px;
            display:flex; 
            flex-direction:column; 
            justify-content:space-between;
        ">
            ${course.image_url ? `<img src="${course.image_url}" alt="${course.title}" style="width:100%; height:160px; object-fit:cover; border-radius:8px; margin-bottom:12px;">` : ''}
            <h3>${course.title}</h3>
            <p>${course.description}</p>
            <p><strong>Duration:</strong> ${course.duration} hours</p>
            <p><strong>Price:</strong> â‚¹${course.price_inr} (INR)</p>
            <p><strong>Category:</strong> ${course.category}</p>
            ${course.status !== 'Approved' ? '<span style="color:#ff9800; font-weight:600;">Pending Approval</span>' : ''}
            <div style="margin-top:15px;">
                ${course.status === 'Approved' ? `<button onclick="enroll(${course.id})" style="background:#4b6cb7; color:#fff; padding:8px 15px; border:none; border-radius:8px; cursor:pointer;">Enroll</button>` : ''}
                ${course.status !== 'Approved' ? `<button onclick="approve(${course.id})" style="background:#28a745; color:#fff; padding:8px 15px; border:none; border-radius:8px; cursor:pointer; margin-right:5px;">Approve</button>
                <button onclick="reject(${course.id})" style="background:#dc3545; color:#fff; padding:8px 15px; border:none; border-radius:8px; cursor:pointer;">Reject</button>` : ''}
            </div>
        </div>
        `;
    }).join('');
}

async function fetchCourses() {
    const container = document.getElementById('course-list');
    const empty = document.getElementById('courses-empty');
    const countEl = document.getElementById('courses-count');
    container.innerHTML = '';
    empty.style.display = 'none';
    countEl.textContent = 'Loading...';
    try {
        const res = await fetch('/api/courses/');
        if (!res.ok) throw new Error('Failed to fetch courses');
        _courses_cache = await res.json();
    } catch (err) {
        container.innerHTML = `<p style="color:#c00">Could not load courses: ${err.message}</p>`;
        countEl.textContent = '0 course(s)';
        return;
    }

    // initial render (no filter)
    applyFiltersAndRender();
}

function applyFiltersAndRender() {
    const onlineOnly = document.getElementById('filter-online').checked;
    let filtered = _courses_cache.slice();
    if (onlineOnly) filtered = filtered.filter(c => !!c.online);
    renderCourses(filtered);
}

function enroll(courseId) {
    const csrftoken = getCookie('csrftoken');
    fetch('/api/enrollments/', {
        method: 'POST',
        credentials: 'same-origin',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ course: courseId })
    }).then(res => res.json())
      .then(data => alert('Enrolled successfully!'))
      .catch(err => alert('Enrollment failed: ' + err.message));
}

function approve(courseId) {
    const csrftoken = getCookie('csrftoken');
    fetch(`/api/courses/${courseId}/approve/`, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': csrftoken } })
        .then(res => res.json())
        .then(data => { alert('Course Approved'); fetchCourses(); })
        .catch(err => alert('Approve failed: ' + err.message));
}

function reject(courseId) {
    const csrftoken = getCookie('csrftoken');
    fetch(`/api/courses/${courseId}/reject/`, { method: 'POST', credentials: 'same-origin', headers: { 'X-CSRFToken': csrftoken } })
        .then(res => res.json())
        .then(data => { alert('Course Rejected'); fetchCourses(); })
        .catch(err => alert('Reject failed: ' + err.message));
}

document.addEventListener('DOMContentLoaded', () => {
    const filterOnline = document.getElementById('filter-online');
    filterOnline.addEventListener('change', applyFiltersAndRender);
    fetchCourses();
});
</script>
{% endblock %}
